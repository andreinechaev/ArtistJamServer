Resources:
  sslSecurityGroupIngress: 
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      #GroupName: {Ref : sg-9a4a78ff}
      GroupId: {Ref : sg-9a4a78ff}
      IpProtocol: tcp
      ToPort: 443
      FromPort: 443
      CidrIp: 0.0.0.0/0
	  
packages:
  yum:
    mod24_ssl : []
    
files:
  /etc/httpd/conf.d/ssl.conf:
    mode: "000755"
    owner: root
    group: root
    content: |
      LoadModule wsgi_module modules/mod_wsgi.so
      WSGIPythonHome /opt/python/run/baselinenv
      WSGISocketPrefix run/wsgi
      WSGIRestrictEmbedded On
      Listen 443
      <VirtualHost *:80>
        ServerName myserver
        Redirect permanent / https://myserver
      </VirtualHost>

      <VirtualHost *:443>
        ServerName myserver


        SSLEngine on
        SSLCertificateFile "/etc/pki/tls/certs/server.crt"
        SSLCertificateKeyFile "/etc/pki/tls/certs/server.key"
        
        Alias /static/ /opt/python/current/app/static/
        <Directory /opt/python/current/app/static>
        Order allow,deny
        Allow from all
        </Directory>
        
        WSGIScriptAlias / /opt/python/current/app/app/run.py
        
        <Directory /opt/python/current/app>
        Require all granted
        </Directory>
        
        WSGIDaemonProcess wsgi-ssl processes=1 threads=15 display-name=%{GROUP} \
          python-path=/opt/python/current/app:/opt/python/run/venv/lib/python2.7/site-packages user=wsgi group=wsgi \
          home=/opt/python/current/app
        WSGIProcessGroup wsgi-ssl
      </VirtualHost>
      
  /etc/pki/tls/certs/server.crt:
    mode: "000400"
    owner: root
    group: root
    content: |
      -----BEGIN CERTIFICATE REQUEST-----
MIIDEjCCAfoCAQAwgZExCzAJBgNVBAYTAlVTMQswCQYDVQQIEwJOWTERMA8GA1UE
BxMITmV3IFlvcmsxEjAQBgNVBAoTCUFydGlzdEphbTETMBEGA1UECxMKRGV2ZWxv
cGluZzEaMBgGA1UEAxMRd3d3LmFydGlzdGphbS5uZXQxHTAbBgkqhkiG9w0BCQEW
DmZhcmFkZXlAbWUuY29tMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA
ylMe6BsKibjT0xkzj0lzEfYfEeDO9/UAq3KwBL/Oy/BGQdlOB9gTwpjKKWr3YZCb
hTxQjqdXbCuu666/bRbo0BD9qPj+6qFGJQX411rEe8vHRbhtjXy8A+YChuG6H9pw
6GjrhKBsu8IYluahKUng6jwZbCI0IbUz45ujQk5voy51Srt/xIkio88RjXtXhuOU
+sGig6T31Tw7k08a1nUNDG6cWYJ+/1RQiBhPFoGwt0Xz/U3zUvEt135f3tMIcPE+
FHbz4M0xkroNIgcBpEAA5NtdRAfZDNx+ASTBBex4BumDP4QJy9EVmy1JZm+hwOJf
0VGrUawj2iQPC4zdAAWqTwIDAQABoDswGQYJKoZIhvcNAQkCMQwTCkFydGlzdCBK
YW0wHgYJKoZIhvcNAQkHMRETD0k1MDExOTkwcGhvZW5peDANBgkqhkiG9w0BAQUF
AAOCAQEAsndiK5RpCv8UfDPoGKhRIQ7hiNlck+qn9wH1WWJQlGwJtP5W3/ekzqYV
xYF4p5kYvcMJ5ER2kYl4U/Vi0OqLS+rN2Hpu40IkYBSCrG68qiL13UqyoPzZ8SEt
ajyE9KJHlN8UUWyV1664aT4r7/Zlhq3NQamLEWjKNVo21AoTckH0cnLrwqCmi/wa
SHSCzeHYWt/eUXV57aXoxr3NUYTjpOoYMxHJHmuaGeF38uVR5YckhzEOwJi+BaAs
6dfAzPNc1DA3UaSlKUt8zvxx5pjaMi+VBYOEC0XlGxVACPLdIwyAt1NRJOKMCfoe
JRdDf/8eZGXpDRb7Srvc8nTP3yH8yw==
-----END CERTIFICATE REQUEST-----
       
  /etc/pki/tls/certs/server.key:
    mode: "000400"
    owner: root
    group: root
    content: |
      -----BEGIN RSA PRIVATE KEY-----
MIIEogIBAAKCAQEAylMe6BsKibjT0xkzj0lzEfYfEeDO9/UAq3KwBL/Oy/BGQdlO
B9gTwpjKKWr3YZCbhTxQjqdXbCuu666/bRbo0BD9qPj+6qFGJQX411rEe8vHRbht
jXy8A+YChuG6H9pw6GjrhKBsu8IYluahKUng6jwZbCI0IbUz45ujQk5voy51Srt/
xIkio88RjXtXhuOU+sGig6T31Tw7k08a1nUNDG6cWYJ+/1RQiBhPFoGwt0Xz/U3z
UvEt135f3tMIcPE+FHbz4M0xkroNIgcBpEAA5NtdRAfZDNx+ASTBBex4BumDP4QJ
y9EVmy1JZm+hwOJf0VGrUawj2iQPC4zdAAWqTwIDAQABAoIBAF3XUcV8DVY1iOIn
lTeHbLzO+Dg1mil91LKwvh1lzYffyOZv4PZYbUnbziCJwXXaOZgBkqenzC+az0X3
RkhV0OP4jX6bBrlS1hMEAxf3vJxitumKkh2G1jnErDVdaxOtIKNbTqm0MtqfOwJ6
tBNPdeeOuofiEWX1Ar02CfIOKU94wMTdYGFBHi1u2hLwup+e76PkXEcjlVrD/q9n
PBTq7XbTE2EI+vNmmR1AkoQ3h97O18+Sv/0x6pc1GonExl+o8utm5HAC6ebQdIGV
7Y91ZRvTRMe63to+lmm1syixm2tdU+G6n5ERKBNn9GQtRFht3YMPW4XVj3WR6XMB
920hlJECgYEA5R7yIe5gZwZ8x0DGu9hXJxwhizBYWla2b8LMxPPdJpaZ4LbGLlhN
oqj65DEtHWhUqt2818BZBPK7YzMII9NPnq3UJJl6FrZpNcL3bMuNGSQcyp6/puSD
HPDWhnvq/alU+ke6RP3tSMltMSMmHLyfDPbVnwfwPdMRrSHW9tqmyIcCgYEA4g9r
oykCaN+RVzH+MZ0aJFtAnFyW/BX8vjfc97xQ2ZomaBtEPo8cmv2uObJrcKqTNT6B
DQUkJmzJPPklGT+1MLNi3RmIKdy+Bz/YgEbocmRg4firhvK7UfPL6v/fO9EDPz4F
vQ8JEvoxJt+q5+aKVmQqp20JrjtGo92JlFOZKfkCgYBaM6GtvBQV21b6dsUGpPhC
vG90Rbcy8ZpnS3CkRUGWdInmDu7cxgTiedY0SivxvOZAUoWLBv3E1e7x8eBNgl6B
IPw44HdRQ8UN1lDkcwp8kFwJZRAcmzAHD8XVMinkbWq4Ec8CZFmrYylqw+S4QYX4
a6DUOCLbpCH8YCsqChDJNwKBgAraBqa8bzstkEKJSdSD4B9iqgVXhH/xZkKTV+4k
ghUQC0vwEySVph/ikZx/bhzoc0yZBYTkfEnD6x0cMKW3ozEFS3elpB2uVQjwDaqK
vNnQ672tPD6sJEXY2C8dvU+XxvogNhJPSHY6wGVHU2LydC2VfV6wI0jT254+Ij6W
jMGxAoGAfgps2alzy8ndRg6xVmLAiFrzmi3Bf5i/2hOxcW+7pL8yJDKQ+JfsuRUm
VSFJklrJnVS1N2y2MirnUgnV3lNkJA2kr8QnzZWwH2Xdg7eoWd0PjP2Igr0ZzSKI
nVRGdFWZRIRxLsDJBTxt9FiYDxlne40WaJnNBAEduQlX6LGHM9M=
-----END RSA PRIVATE KEY-----

container_commands:
  01killhttpd:
    command: "killall httpd"
  02waitforhttpddeath:
    command: "sleep 3"
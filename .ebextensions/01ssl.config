Resources:
  sslSecurityGroupIngress: 
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: sg-9a4a78ff
      # GroupId: {Ref : AWSEBSecurityGroup}
      IpProtocol: tcp
      ToPort: 443
      FromPort: 443
      CidrIp: 0.0.0.0/0

packages:
  yum:
    mod24_ssl : []
    
files:
  /etc/httpd/conf.d/ssl.conf:
    mode: "000755"
    owner: root
    group: root
    content: |
      LoadModule wsgi_module modules/mod_wsgi.so
      WSGIPythonHome /opt/python/run/baselinenv
      WSGISocketPrefix run/wsgi
      WSGIRestrictEmbedded On
      Listen 443
      <VirtualHost *:80>
        ServerName www.artistjam.net
        Redirect permanent / https://www.artistjam.net
      </VirtualHost>

      <VirtualHost *:443>
        ServerName www.artistjam.net


        SSLEngine on
        SSLCertificateFile "/etc/pki/tls/certs/server.crt"
        SSLCertificateKeyFile "/etc/pki/tls/certs/server.key"
        
        Alias /static/ /opt/python/current/app/static/
        <Directory /opt/python/current/app/static>
        Order allow,deny
        Allow from all
        </Directory>
        
        WSGIScriptAlias / /opt/python/current/app/app/run.py
        
        <Directory /opt/python/current/app>
        Require all granted
        </Directory>
        
        WSGIDaemonProcess wsgi-ssl processes=1 threads=15 display-name=%{GROUP} \
          python-path=/opt/python/current/app:/opt/python/run/venv/lib/python2.7/site-packages user=wsgi group=wsgi \
          home=/opt/python/current/app
        WSGIProcessGroup wsgi-ssl
      </VirtualHost>
      
  /etc/pki/tls/certs/server.crt:
    mode: "000400"
    owner: root
    group: root
    content: |
      -----BEGIN CERTIFICATE-----
      MIIFTDCCBDSgAwIBAgIQfVMSSP22ByrDbh1Dwx0A9DANBgkqhkiG9w0BAQsFADCB
      kDELMAkGA1UEBhMCR0IxGzAZBgNVBAgTEkdyZWF0ZXIgTWFuY2hlc3RlcjEQMA4G
      A1UEBxMHU2FsZm9yZDEaMBgGA1UEChMRQ09NT0RPIENBIExpbWl0ZWQxNjA0BgNV
      BAMTLUNPTU9ETyBSU0EgRG9tYWluIFZhbGlkYXRpb24gU2VjdXJlIFNlcnZlciBD
      QTAeFw0xNTA2MjEwMDAwMDBaFw0xNTA5MTkyMzU5NTlaMFIxITAfBgNVBAsTGERv
      bWFpbiBDb250cm9sIFZhbGlkYXRlZDERMA8GA1UECxMIRnJlZSBTU0wxGjAYBgNV
      BAMTEXd3dy5hcnRpc3RqYW0ubmV0MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIB
      CgKCAQEAylMe6BsKibjT0xkzj0lzEfYfEeDO9/UAq3KwBL/Oy/BGQdlOB9gTwpjK
      KWr3YZCbhTxQjqdXbCuu666/bRbo0BD9qPj+6qFGJQX411rEe8vHRbhtjXy8A+YC
      huG6H9pw6GjrhKBsu8IYluahKUng6jwZbCI0IbUz45ujQk5voy51Srt/xIkio88R
      jXtXhuOU+sGig6T31Tw7k08a1nUNDG6cWYJ+/1RQiBhPFoGwt0Xz/U3zUvEt135f
      3tMIcPE+FHbz4M0xkroNIgcBpEAA5NtdRAfZDNx+ASTBBex4BumDP4QJy9EVmy1J
      Zm+hwOJf0VGrUawj2iQPC4zdAAWqTwIDAQABo4IB3TCCAdkwHwYDVR0jBBgwFoAU
      kK9qOpRaC9iQ6hJWc99DtDoo2ucwHQYDVR0OBBYEFFzpQLmPKS3iiLrYF5DpfVO9
      sqCSMA4GA1UdDwEB/wQEAwIFoDAMBgNVHRMBAf8EAjAAMB0GA1UdJQQWMBQGCCsG
      AQUFBwMBBggrBgEFBQcDAjBPBgNVHSAESDBGMDoGCysGAQQBsjEBAgIHMCswKQYI
      KwYBBQUHAgEWHWh0dHBzOi8vc2VjdXJlLmNvbW9kby5jb20vQ1BTMAgGBmeBDAEC
      ATBUBgNVHR8ETTBLMEmgR6BFhkNodHRwOi8vY3JsLmNvbW9kb2NhLmNvbS9DT01P
      RE9SU0FEb21haW5WYWxpZGF0aW9uU2VjdXJlU2VydmVyQ0EuY3JsMIGFBggrBgEF
      BQcBAQR5MHcwTwYIKwYBBQUHMAKGQ2h0dHA6Ly9jcnQuY29tb2RvY2EuY29tL0NP
      TU9ET1JTQURvbWFpblZhbGlkYXRpb25TZWN1cmVTZXJ2ZXJDQS5jcnQwJAYIKwYB
      BQUHMAGGGGh0dHA6Ly9vY3NwLmNvbW9kb2NhLmNvbTArBgNVHREEJDAighF3d3cu
      YXJ0aXN0amFtLm5ldIINYXJ0aXN0amFtLm5ldDANBgkqhkiG9w0BAQsFAAOCAQEA
      SucuiO9nWRvhhs7oexvM17Frc6CfBsGNaxZKbD4is+MMy4klQAyo5JeCsLl5nGv8
      ybVsQTNsWPCQnPUbTrJ4kUehk+r35ZSbR2SRYKmgsZkfmpzSZ+o5i5iRYHk0z0Bz
      4LF9mj9U5IjAEPJjYENr+8pp3i/ES4eBHycH35B71TuPM+HZIXz7YZVunKizy0Ei
      /t3ee0tmYfvYIP2koaLzR7ximlRvBwMWoklNNxQ6IzCOtjdzdKz9as9y2qlComcc
      skFE9wOj654RiwJV2KkMheA5Kt9XTyKzrrYSNi0vSflW/0e3QAadsRCbtyaeXqTg
      e6p5D9eYG8rMPefs5DOYdw==
      -----END CERTIFICATE-----
       
  /etc/pki/tls/certs/server.key:
    mode: "000400"
    owner: root
    group: root
    content: |
      -----BEGIN RSA PRIVATE KEY-----
      MIIEogIBAAKCAQEAylMe6BsKibjT0xkzj0lzEfYfEeDO9/UAq3KwBL/Oy/BGQdlO
      B9gTwpjKKWr3YZCbhTxQjqdXbCuu666/bRbo0BD9qPj+6qFGJQX411rEe8vHRbht
      jXy8A+YChuG6H9pw6GjrhKBsu8IYluahKUng6jwZbCI0IbUz45ujQk5voy51Srt/
      xIkio88RjXtXhuOU+sGig6T31Tw7k08a1nUNDG6cWYJ+/1RQiBhPFoGwt0Xz/U3z
      UvEt135f3tMIcPE+FHbz4M0xkroNIgcBpEAA5NtdRAfZDNx+ASTBBex4BumDP4QJ
      y9EVmy1JZm+hwOJf0VGrUawj2iQPC4zdAAWqTwIDAQABAoIBAF3XUcV8DVY1iOIn
      lTeHbLzO+Dg1mil91LKwvh1lzYffyOZv4PZYbUnbziCJwXXaOZgBkqenzC+az0X3
      RkhV0OP4jX6bBrlS1hMEAxf3vJxitumKkh2G1jnErDVdaxOtIKNbTqm0MtqfOwJ6
      tBNPdeeOuofiEWX1Ar02CfIOKU94wMTdYGFBHi1u2hLwup+e76PkXEcjlVrD/q9n
      PBTq7XbTE2EI+vNmmR1AkoQ3h97O18+Sv/0x6pc1GonExl+o8utm5HAC6ebQdIGV
      7Y91ZRvTRMe63to+lmm1syixm2tdU+G6n5ERKBNn9GQtRFht3YMPW4XVj3WR6XMB
      920hlJECgYEA5R7yIe5gZwZ8x0DGu9hXJxwhizBYWla2b8LMxPPdJpaZ4LbGLlhN
      oqj65DEtHWhUqt2818BZBPK7YzMII9NPnq3UJJl6FrZpNcL3bMuNGSQcyp6/puSD
      HPDWhnvq/alU+ke6RP3tSMltMSMmHLyfDPbVnwfwPdMRrSHW9tqmyIcCgYEA4g9r
      oykCaN+RVzH+MZ0aJFtAnFyW/BX8vjfc97xQ2ZomaBtEPo8cmv2uObJrcKqTNT6B
      DQUkJmzJPPklGT+1MLNi3RmIKdy+Bz/YgEbocmRg4firhvK7UfPL6v/fO9EDPz4F
      vQ8JEvoxJt+q5+aKVmQqp20JrjtGo92JlFOZKfkCgYBaM6GtvBQV21b6dsUGpPhC
      vG90Rbcy8ZpnS3CkRUGWdInmDu7cxgTiedY0SivxvOZAUoWLBv3E1e7x8eBNgl6B
      IPw44HdRQ8UN1lDkcwp8kFwJZRAcmzAHD8XVMinkbWq4Ec8CZFmrYylqw+S4QYX4
      a6DUOCLbpCH8YCsqChDJNwKBgAraBqa8bzstkEKJSdSD4B9iqgVXhH/xZkKTV+4k
      ghUQC0vwEySVph/ikZx/bhzoc0yZBYTkfEnD6x0cMKW3ozEFS3elpB2uVQjwDaqK
      vNnQ672tPD6sJEXY2C8dvU+XxvogNhJPSHY6wGVHU2LydC2VfV6wI0jT254+Ij6W
      jMGxAoGAfgps2alzy8ndRg6xVmLAiFrzmi3Bf5i/2hOxcW+7pL8yJDKQ+JfsuRUm
      VSFJklrJnVS1N2y2MirnUgnV3lNkJA2kr8QnzZWwH2Xdg7eoWd0PjP2Igr0ZzSKI
      nVRGdFWZRIRxLsDJBTxt9FiYDxlne40WaJnNBAEduQlX6LGHM9M=
      -----END RSA PRIVATE KEY-----

container_commands:
  01killhttpd:
    command: "killall httpd"
  02waitforhttpddeath:
    command: "sleep 3"